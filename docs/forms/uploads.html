<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>3. File Uploads &#8212; Yada Framework master documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/yadaDocs.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    <script type="text/javascript" src="../_static/yadaDocs.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. DataTables" href="../datatables.html" />
    <link rel="prev" title="2. Forms" href="overview.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Yada Framework</a>
        <span class="navbar-text navbar-version pull-left"><b>master</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="fieldsComponents.html">1. Form Fields and Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">2. Forms</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. File Uploads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datatables.html">4. Data Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ajax.html">5. Ajax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ajaxModal.html">6. Ajax Modal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notificationModal.html">7. Notification Modal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../newEclipseProject.html">8. New Eclipse Project</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">3. File Uploads</a><ul>
<li><a class="reference internal" href="#description">3.1. Description</a></li>
<li><a class="reference internal" href="#configuration">3.2. Configuration</a><ul>
<li><a class="reference internal" href="#maximum-file-size-setting">3.2.1. Maximum file size setting</a></li>
<li><a class="reference internal" href="#maximum-file-size-check">3.2.2. Maximum file size check</a></li>
</ul>
</li>
<li><a class="reference internal" href="#html">3.3. HTML</a><ul>
<li><a class="reference internal" href="#form-fragment-yada-form-fileupload">3.3.1. Form Fragment /yada/form/fileUpload</a></li>
</ul>
</li>
<li><a class="reference internal" href="#java">3.4. JAVA</a><ul>
<li><a class="reference internal" href="#just-save-the-file">3.4.1. Just save the file</a></li>
<li><a class="reference internal" href="#yadaattachedfile">3.4.2. YadaAttachedFile</a></li>
<li><a class="reference internal" href="#yadafilemanager">3.4.3. YadaFileManager</a><ul>
<li><a class="reference internal" href="#introduction">3.4.3.1. Introduction</a></li>
<li><a class="reference internal" href="#saving-the-file">3.4.3.2. Saving the file</a></li>
<li><a class="reference internal" href="#image-variants">3.4.3.3. Image variants</a></li>
<li><a class="reference internal" href="#file-url">3.4.3.4. File URL</a></li>
<li><a class="reference internal" href="#delete-files">3.4.3.5. Delete Files</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="overview.html" title="Previous Chapter: 2. Forms"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 2. Forms</span>
    </a>
  </li>
  <li>
    <a href="../datatables.html" title="Next Chapter: 4. DataTables"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">4. DataTables &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/forms/uploads.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="file-uploads">
<h1>3. File Uploads<a class="headerlink" href="#file-uploads" title="Permalink to this headline">¶</a></h1>
<p class="rubric">Uploading files to the server, handling and linking them</p>
<div class="section" id="description">
<h2>3.1. Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>File Upload is handled via <a class="reference external" href="https://commons.apache.org/proper/commons-fileupload/">Commons FileUpload</a>. We don’t use the Servlet 3 API because, when we had to make a choice,
we couldn’t figure out how to set the file size limit via our configuration file.</p>
<p>Yada offers some utility classes to more easily handle files <em>after</em> they have been uploaded:</p>
<ul class="simple">
<li><p>storing files on disk</p></li>
<li><p>resizing images</p></li>
<li><p>assigning files to Entity objects</p></li>
<li><p>generating download links</p></li>
<li><p>managing the pool of uploaded files</p></li>
</ul>
</div>
<div class="section" id="configuration">
<h2>3.2. Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="maximum-file-size-setting">
<h3>3.2.1. Maximum file size setting<a class="headerlink" href="#maximum-file-size-setting" title="Permalink to this headline">¶</a></h3>
<p>You can set the maximum file size for an upload by means of the maxFileUploadSizeBytes configuration entry:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;config&gt;</span>
        <span class="nt">&lt;maxFileUploadSizeBytes&gt;</span>3000000<span class="nt">&lt;/maxFileUploadSizeBytes&gt;</span>
</pre></div>
</div>
<p>The default is 50MB.</p>
</div>
<div class="section" id="maximum-file-size-check">
<h3>3.2.2. Maximum file size check<a class="headerlink" href="#maximum-file-size-check" title="Permalink to this headline">¶</a></h3>
<p>When the upload limit is reached, a message is logged with a debug severity. You can ensure to see the message with the following logback configuration:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;logger</span> <span class="na">name=</span><span class="s">&quot;org.springframework.web.multipart.commons.YadaCommonsMultipartResolver&quot;</span> <span class="na">level=</span><span class="s">&quot;DEBUG&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>A Request Attribute is also added to the Request with the name MaxUploadSizeExceededException and the MaxUploadSizeExceededException as a value.
All Request Parameters sent with the form are lost.</p>
<p>By default, Tomcat will also drop the connection and no response will be sent to the browser. This will result in a low-level error shown by the browser.
The reason for this is explained <a class="reference external" href="https://www.mkyong.com/spring/spring-file-upload-and-connection-reset-issue/">here</a> and can only avoided if you configure Tomcat not to drop the connection but keep uploading any excess data (<code class="docutils literal notranslate"><span class="pre">maxSwallowSize=&quot;-1&quot;</span></code>).
The drawback would be that network bandwidth would be wasted and the user will have to wait until the whole file is uploaded before being told that it was too big.
The best solution would be to only check file size on the browser via javascript. This is not currently implemented in Yada but is something like the following:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">fileTooBig</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input[name=attachment]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="o">==</span><span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">sizeMega</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">size</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">sizeMega</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#fileTooBig&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#fileTooBig&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input[name=attachment]&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fileTooBig</span><span class="p">();</span>
<span class="p">});</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#theForm&#39;</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fileTooBig</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="admonition-title">Todo</p>
<p>Automate javascript checking of file size</p>
</div>
</div>
</div>
<div class="section" id="html">
<h2>3.3. HTML<a class="headerlink" href="#html" title="Permalink to this headline">¶</a></h2>
<p>File upload starts from a <code class="docutils literal notranslate"><span class="pre">&quot;multipart/form-data&quot;</span></code> form. This is a standard form with a input element of type <code class="docutils literal notranslate"><span class="pre">&quot;file&quot;</span></code>:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&quot;multipart/form-data&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;doUpload&quot;</span><span class="p">&gt;</span>
        File to upload: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;file&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;upfile&quot;</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Press&quot;</span><span class="p">&gt;</span> to upload the file!
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="section" id="form-fragment-yada-form-fileupload">
<h3>3.3.1. Form Fragment /yada/form/fileUpload<a class="headerlink" href="#form-fragment-yada-form-fileupload" title="Permalink to this headline">¶</a></h3>
<p>If you’re using a <em>form backing bean</em> you can include a yada fragment for the input tag. The following example also shows any error:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">th:action</span><span class="o">=</span><span class="s">&quot;@{/profile}&quot;</span> <span class="na">th:object</span><span class="o">=</span><span class="s">&quot;${formProfile}&quot;</span> <span class="na">enctype</span><span class="o">=</span><span class="s">&quot;multipart/form-data&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span>
<span class="na">th:classappend</span><span class="o">=</span><span class="s">&quot;${#fields.hasErrors(&#39;*&#39;)}? has-error&quot;</span> <span class="na">role</span><span class="o">=</span><span class="s">&quot;form&quot;</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&quot;/yada/form/fileUpload::field(fieldName=&#39;avatarImage&#39;,label=&#39;Avatar&#39;)&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>You can display a link to the uploaded file underneath the input field by passing an instance of <code class="docutils literal notranslate"><span class="pre">YadaAttachedFile</span></code> to the <code class="docutils literal notranslate"><span class="pre">attachedFile</span></code> fragment attribute.
For other usage instructions see the source file for <code class="docutils literal notranslate"><span class="pre">/yada/form/fileUpload</span></code>.</p>
</div>
</div>
<div class="section" id="java">
<h2>3.4. JAVA<a class="headerlink" href="#java" title="Permalink to this headline">¶</a></h2>
<p>After submission, the uploaded file will be processed by <em>Commons File Upload</em> and sent to the &#64;Controller as a <code class="docutils literal notranslate"><span class="pre">MultipartFile</span></code> object.
You would normally add a field of that type to the <em>form backing bean</em>, but you can also handle it independently from the other form fields if you wish,
by adding it to the &#64;RequestMapping signature.</p>
<p>In the &#64;Controller you have many options.</p>
<div class="section" id="just-save-the-file">
<h3>3.4.1. Just save the file<a class="headerlink" href="#just-save-the-file" title="Permalink to this headline">¶</a></h3>
<p>You can just save the file somewhere with YadaWebUtil.saveAttachment():</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">storeFile</span><span class="o">(</span><span class="n">MultipartFile</span> <span class="n">submittedFile</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">destination</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;someFolder&quot;</span><span class="o">);</span>
        <span class="n">YadaWebUtil</span><span class="o">.</span><span class="na">saveAttachment</span><span class="o">(</span><span class="n">submittedFile</span><span class="o">,</span> <span class="n">destination</span><span class="o">):</span>
</pre></div>
</div>
<p>Then you will have to keep track of the file yourself somehow. The following sections show an alternative and more convenient way of dealing with file uploads.</p>
</div>
<div class="section" id="yadaattachedfile">
<h3>3.4.2. YadaAttachedFile<a class="headerlink" href="#yadaattachedfile" title="Permalink to this headline">¶</a></h3>
<p>Usually the uploaded file has to be associated to some Entity in the database: a user avatar or CV, the image of a product, the pdf for a trip.
Use YadaAttachedFile to easily handle file attachments:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>

        <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">cascade</span><span class="o">=</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">REMOVE</span><span class="o">,</span> <span class="n">orphanRemoval</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
        <span class="kd">protected</span> <span class="n">YadaAttachedFile</span> <span class="n">icon</span><span class="o">;</span>

        <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">cascade</span><span class="o">=</span><span class="n">CascadeType</span><span class="o">.</span><span class="na">REMOVE</span><span class="o">,</span> <span class="n">orphanRemoval</span><span class="o">=</span><span class="kc">true</span><span class="o">)</span>
        <span class="kd">protected</span> <span class="n">YadaAttachedFile</span> <span class="n">specSheet</span><span class="o">;</span>
</pre></div>
</div>
<p>After doing this you can make use of the functionality of YadaFileManager explained below.
Strictly speaking, the above annotation is not needed because YadaAttachedFile instances can exist on their own, having the entity id as a field,
but this wouldn’t enforce database integrity.</p>
<p>The YadaAttachedFile class stores some file-related information that you might want to keep:</p>
<ul class="simple">
<li><p>the original name of the file uploaded by the user</p></li>
<li><p>the upload time</p></li>
<li><p>localized title and description</p></li>
<li><p>the folder where the file is stored</p></li>
<li><p>the name of three versions of the file: the original one and the ones scaled for desktop and mobile</p></li>
<li><p>the sort order relative to files of the same “group”</p></li>
<li><p>the Entity to which the file is attached</p></li>
<li><p>a “published” flag</p></li>
<li><p>a locale if the file has to be made available only to some specific locale. This could be useful for pdf files in different languages</p></li>
</ul>
</div>
<div class="section" id="yadafilemanager">
<h3>3.4.3. YadaFileManager<a class="headerlink" href="#yadafilemanager" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>3.4.3.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<p>The YadaFileManager &#64;Component is the single entry to all operations on uploaded files.</p>
<p>Every time a file is uploaded, it is stored in a folder named “uploads” in the &lt;basePath&gt; configured directory. This folder is
created automatically if the tomcat process has enough permissions, otherwise you have to create it manually.</p>
</div>
<div class="section" id="saving-the-file">
<h4>3.4.3.2. Saving the file<a class="headerlink" href="#saving-the-file" title="Permalink to this headline">¶</a></h4>
<p>Every file is stored using the original file name. To prevent name duplicates a number is automatically appended at the end.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">String</span> <span class="nf">updateProfile</span><span class="o">(</span><span class="n">MultipartFile</span> <span class="n">thumbnailImage</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">managedFile</span> <span class="o">=</span> <span class="n">yadaFileManager</span><span class="o">.</span><span class="na">uploadFile</span><span class="o">(</span><span class="n">thumbnailImage</span><span class="o">);</span>
</pre></div>
</div>
<p>The File can then be attached to an Entity:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">yadaFileManager</span><span class="o">.</span><span class="na">attachNew</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">managedFile</span><span class="o">,</span> <span class="s">&quot;userData&quot;</span><span class="o">,</span> <span class="s">&quot;icon&quot;</span><span class="o">);</span>
</pre></div>
</div>
<p>When the attach method is called, the original uploaded file is copied from the “uploads” folder into the target folder.
The new file will have the new prefix specified and the YadaAttachedFile id at the end of the name.
The original file is by default deleted from the “uploads” folder unless a specific configuration is set to false:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;yadaFileManager&gt;</span>
        <span class="nt">&lt;deleteUploads&gt;</span>false<span class="nt">&lt;/deleteUploads&gt;</span>
<span class="nt">&lt;/yadaFileManager&gt;</span>
</pre></div>
</div>
<p>Not deleting uploaded files allows the implementation of a filesystem-like feature where single files could be reused many times.</p>
<div class="admonition-todo admonition" id="index-1">
<p class="admonition-title">Todo</p>
<p>implement filesystem feature</p>
</div>
<p>The association between the owning Entity and the new YadaAttachedFile instance is not created automatically by yadaFileManager.attachNew() and you
have to do it explicitly:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">YadaAttachedFile</span> <span class="n">newIcon</span> <span class="o">=</span> <span class="n">yadaFileManager</span><span class="o">.</span><span class="na">attachNew</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">managedFile</span><span class="o">,</span> <span class="s">&quot;userData&quot;</span><span class="o">,</span> <span class="s">&quot;icon&quot;</span><span class="o">);</span>
<span class="n">user</span><span class="o">.</span><span class="na">setIcon</span><span class="o">(</span><span class="n">newIcon</span><span class="o">);</span>
<span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</pre></div>
</div>
<p>In case you’re replacing a previous attachment, you only need to pass the previous YadaAttachedFile: the old files will be deleted and replaced with
the new ones. Non database operation is needed in this case.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">YadaAttachedFile</span> <span class="n">previousIcon</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getIcon</span><span class="o">();</span>
<span class="n">YadaAttachedFile</span> <span class="n">iconAttachedFile</span> <span class="o">=</span> <span class="n">yadaFileManager</span><span class="o">.</span><span class="na">attachReplace</span><span class="o">(</span><span class="n">previousIcon</span><span class="o">,</span> <span class="n">managedFile</span><span class="o">,</span> <span class="s">&quot;icon&quot;</span><span class="o">,</span> <span class="s">&quot;jpg&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-2">
<p class="admonition-title">Todo</p>
<p>test that the above code works</p>
</div>
</div>
<div class="section" id="image-variants">
<h4>3.4.3.3. Image variants<a class="headerlink" href="#image-variants" title="Permalink to this headline">¶</a></h4>
<p>If the uploaded file is an image, it can be resized for desktop and mobile as needed by specifying the alternative dimensions:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">yadaFileManager</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">managedFile</span><span class="o">,</span> <span class="s">&quot;userData&quot;</span><span class="o">,</span> <span class="s">&quot;icon&quot;</span><span class="o">,</span> <span class="s">&quot;jpg&quot;</span><span class="o">,</span> <span class="mi">1280</span><span class="o">,</span> <span class="mi">768</span><span class="o">);</span>
</pre></div>
</div>
<p>In the above example the image is converted to jpg and two additional versions are saved on disk.
The conversion is performed with the command line tool configured in <code class="docutils literal notranslate"><span class="pre">config/shell/resize</span></code> (usually imagemagick).</p>
<div class="admonition-todo admonition" id="index-3">
<p class="admonition-title">Todo</p>
<p>link to the configuration section</p>
</div>
</div>
<div class="section" id="file-url">
<h4>3.4.3.4. File URL<a class="headerlink" href="#file-url" title="Permalink to this headline">¶</a></h4>
<p>In order to show images and allow file download, you need to add the relevant URL to the page.
This is done by the methods <code class="docutils literal notranslate"><span class="pre">YadaFileManager.getFileUrl()</span></code>, <code class="docutils literal notranslate"><span class="pre">YadaFileManager.getDesktopImageUrl()</span></code>, <code class="docutils literal notranslate"><span class="pre">YadaFileManager.getMobileImageUrl()</span></code> that can
either be used in the &#64;Controller or directly in the HTML:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">img</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{${@yadaFileManager.getDesktopImageUrl(user.icon)}}&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{${@yadaFileManager.getFileUrl(product.manual)}}&quot;</span><span class="p">&gt;</span>Download manual<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>If you call <code class="docutils literal notranslate"><span class="pre">getMobileImageUrl()</span></code> and a mobile image is not present, it will fall back to <code class="docutils literal notranslate"><span class="pre">getDesktopImageUrl()</span></code> which in turn
falls back to <code class="docutils literal notranslate"><span class="pre">getFileUrl()</span></code>.</p>
</div>
<div class="section" id="delete-files">
<h4>3.4.3.5. Delete Files<a class="headerlink" href="#delete-files" title="Permalink to this headline">¶</a></h4>
<p>Files can be removed from the filesystem with <code class="docutils literal notranslate"><span class="pre">YadaFileManager.deleteFileAttachment()</span></code>. All database objects must then be deleted manually.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">YadaAttachedFile</span> <span class="n">icon</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getIcon</span><span class="o">();</span>
<span class="n">yadaFileManager</span><span class="o">.</span><span class="na">deleteFileAttachment</span><span class="o">(</span><span class="n">icon</span><span class="o">);</span>
<span class="n">yadaAttachedFileRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">icon</span><span class="o">);</span>
<span class="n">user</span><span class="o">.</span><span class="na">setIcon</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-4">
<p class="admonition-title">Todo</p>
<p>test that the above code works</p>
</div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Cristian Ghezzi.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>