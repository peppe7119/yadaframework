<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>11. Database Pagination &#8212; Yada Framework master documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/yadaDocs.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    <script type="text/javascript" src="../_static/yadaDocs.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="12. Troubleshooting" href="../troubleshooting.html" />
    <link rel="prev" title="10. Notification Modal" href="../notificationModal.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Yada Framework</a>
        <span class="navbar-text navbar-version pull-left"><b>master</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../newEclipseProject.html">2. New Eclipse Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internationalization.html">3. Internationalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forms/fieldsComponents.html">4. Form Fields and Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forms/overview.html">5. Forms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forms/uploads.html">6. File Uploads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datatables.html">7. Data Tables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ajax.html">8. Ajax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ajaxModal.html">9. Ajax Modal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notificationModal.html">10. Notification Modal</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">11. Database Pagination</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">12. Troubleshooting</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">11. Database Pagination</a><ul>
<li><a class="reference internal" href="#description">11.1. Description</a></li>
<li><a class="reference internal" href="#first-query">11.2. First query</a></li>
<li><a class="reference internal" href="#load-more-query">11.3. Load More query</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../notificationModal.html" title="Previous Chapter: 10. Notification Modal"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 10. Notificat...</span>
    </a>
  </li>
  <li>
    <a href="../troubleshooting.html" title="Next Chapter: 12. Troubleshooting"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">12. Troubleshooting &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/database/pagination.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="database-pagination">
<h1>11. Database Pagination<a class="headerlink" href="#database-pagination" title="Permalink to this headline">¶</a></h1>
<p class="rubric">Fetch big data one piece at a time</p>
<div class="section" id="description">
<h2>11.1. Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>Loading the whole content of a table onto a web page is never a good idea if the row count is high, both
from a performance and usability perspective.
In such case it’s better to implement database pagination: loading a few rows at a time via ajax when the user wants
to see more.
This section shows how to implement pagination on a web page using a “load more” button, with support
for bookmarking and for the
browser back button: when going back to a web page where more data was loaded, that data is still there.</p>
</div>
<div class="section" id="first-query">
<h2>11.2. First query<a class="headerlink" href="#first-query" title="Permalink to this headline">¶</a></h2>
<p>The “first query” happens when a user loads the web page for the first time, either from normal link navigation
(e.g. a “Show all transactions” link) or by typing a search string into a form and sending it.
The first query will receive any search keywords, will query the database for results, and will return the
results building a page with a “load more” button when there is more data to show.</p>
<p>The “first query” is also called when the user later reloads the web page using the browser “refresh” button,
using the browser “back” button or by clicking on a previously saved bookmark.</p>
<p>It is therefore important that the method handling the first query receives the information needed to load
as many rows as were loaded by the user using the “load more” button. This information is stored in a <code class="docutils literal notranslate"><span class="pre">YadaPageRequest</span></code>:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">th:action</span><span class="o">=</span><span class="s">&quot;@{/searchBook}&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;searchString&quot;</span> <span class="na">th:value</span><span class="o">=</span><span class="s">&quot;${searchString}&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookController</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">PAGE_SIZE</span> <span class="o">=</span>  <span class="mi">10</span><span class="o">;</span>
        <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/searchBook&quot;</span><span class="o">)</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">searchBook</span><span class="o">(</span><span class="n">String</span> <span class="n">searchString</span><span class="o">,</span> <span class="n">YadaPageRequest</span> <span class="n">yadaPageRequest</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
</pre></div>
</div>
<p>When the web page is loaded for the first time, Spring calls the “first query” method and creates an instance of
YadaPageRequest but doesn’t set any values in it because there are no request parameters to set.
You should check if the yadaPageRequest is valid and set it to a default initial value when it’s not,
then call the proper DAO to fetch data from the database, that will be stored in a <code class="docutils literal notranslate"><span class="pre">YadaPageRows</span></code> instance:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">(!</span><span class="n">yadaPageRequest</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">yadaPageRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">YadaPageRequest</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">PAGE_SIZE</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">YadaPageRows</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">searchDao</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">searchString</span><span class="o">,</span> <span class="n">yadaPageRequest</span><span class="o">);</span>
<span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;books&quot;</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
<span class="k">return</span> <span class="s">&quot;/searchResult&quot;</span><span class="o">;</span>
</pre></div>
</div>
<p>The DAO will have to fetch as many rows as needed:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Repository</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SearchDao</span> <span class="o">{</span>
        <span class="nd">@PersistenceContext</span> <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>

        <span class="kd">public</span> <span class="n">YadaPageRows</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="nf">find</span><span class="o">(</span><span class="n">String</span> <span class="n">searchString</span><span class="o">,</span> <span class="n">YadaPageRequest</span> <span class="n">yadaPageRequest</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">List</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="n">found</span> <span class="o">=</span> <span class="n">YadaSql</span><span class="o">.</span><span class="na">instance</span><span class="o">().</span><span class="na">selectFrom</span><span class="o">(</span><span class="s">&quot;from Book b&quot;</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">&quot;b.title LIKE CONCAT(&#39;%&#39;,:search,&#39;%&#39;)&quot;</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">&quot;search&quot;</span><span class="o">,</span> <span class="n">searchString</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">em</span><span class="o">,</span> <span class="n">Book</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="n">yadaPageRequest</span><span class="o">.</span><span class="na">getFirstResult</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="n">yadaPageRequest</span><span class="o">.</span><span class="na">getMaxResults</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">YadaPageRows</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;(</span><span class="n">found</span><span class="o">,</span> <span class="n">yadaPageRequest</span><span class="o">);</span>
        <span class="o">}</span>
</pre></div>
</div>
<p>It is very important to use the <code class="docutils literal notranslate"><span class="pre">setFirstResult</span></code> and <code class="docutils literal notranslate"><span class="pre">setMaxResults</span></code> methods as shown above in order to
implement pagination.</p>
<p>The result can be shown with the following <code class="docutils literal notranslate"><span class="pre">searchResult.html</span></code>:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:unless</span><span class="o">=</span><span class="s">&quot;${books.empty}&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th:block</span> <span class="na">fragment</span><span class="o">=</span><span class="s">&quot;bookList&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:each</span><span class="o">=</span><span class="s">&quot;book : ${books}&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${book.title}&quot;</span><span class="p">&gt;</span>Book title here<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;loadMoreBooks&quot;</span> <span class="na">th:unless</span><span class="o">=</span><span class="s">&quot;${books.last}&quot;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;yadaAjax&quot;</span>
                                <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{/searchBookMore(searchString=${searchString},page=${books.nextPage},size=${books.pageSize})}&quot;</span>
                                <span class="na">yada:paginationHistory</span><span class="o">=</span><span class="s">&quot;&#39;page, size, loadPrevious&#39;&quot;</span>
                                <span class="na">yada:updateOnSuccess</span><span class="o">=</span><span class="s">&quot;&#39;#loadMoreBooks&#39;&quot;</span><span class="p">&gt;</span>Load More
                        <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">th:block</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="load-more-query">
<h2>11.3. Load More query<a class="headerlink" href="#load-more-query" title="Permalink to this headline">¶</a></h2>
<p>The above code prints the found rows, then adds a “Load More” link in case there are more results.
When the user clicks on that link, an ajax call is made to the server in order to fetch the next page:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/searchBookMore&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">addBook</span><span class="o">(</span><span class="n">String</span> <span class="n">searchString</span><span class="o">,</span> <span class="n">YadaPageRequest</span> <span class="n">yadaPageRequest</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">YadaPageRows</span><span class="o">&lt;</span><span class="n">Book</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">searchDao</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">searchString</span><span class="o">,</span> <span class="n">yadaPageRequest</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;books&quot;</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;/searchResult :: bookList&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>That’s all there is to it.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">yada:paginationHistory</span></code> attribute will add the <code class="docutils literal notranslate"><span class="pre">page</span></code>, <code class="docutils literal notranslate"><span class="pre">size</span></code> and <code class="docutils literal notranslate"><span class="pre">loadPrevious</span></code> request
parameters to the current page URL in the history, so that when using a bookmark, reloading or using
the back button those values will be sent to the “first query” method seen at the start, and all
pages up to the current one will be fetched from database and shown. In particular, the <code class="docutils literal notranslate"><span class="pre">loadPrevious=true</span></code>
parameter is the one needed to load all elements previously loaded via pagination.</p>
<p>This example can of course be optimized by using a single method both for the first query and for the following ones,
and many paginations can be used on a single web page by keeping distinct <code class="docutils literal notranslate"><span class="pre">yada:paginationHistory</span></code> parameters.</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Cristian Ghezzi.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>